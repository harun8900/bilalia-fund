<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صندوق البلالية الطبي | السحابة</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #050a18; --card: #0f172a; --blue: #00d2ff; --green: #00e676; --red: #ff5252; --gold: #ffd700; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 0; }
        .header { padding: 30px; text-align: center; border-bottom: 2px solid var(--blue); background: #111a2e; }
        .container { max-width: 900px; margin: 0 auto; padding: 15px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; }
        .stat-card span { display: block; font-size: 20px; font-weight: bold; margin-top: 5px; }
        .admin-box { background: rgba(0,210,255,0.05); padding: 20px; border-radius: 15px; border: 1px dashed var(--blue); margin-bottom: 25px; }
        input, select { background: #1a253d; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; margin: 5px; width: calc(100% - 30px); }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn-blue { background: var(--blue); color: #000; }
        .btn-red { background: var(--red); color: white; }
        .month-block { background: var(--card); border-radius: 15px; margin-bottom: 25px; border: 1px solid rgba(0,210,255,0.1); overflow: hidden; }
        .m-header { background: #152036; padding: 15px; display: flex; justify-content: space-between; align-items: center; color: var(--gold); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .hidden { display: none !important; }
        footer { text-align: center; padding: 40px; color: #475569; font-size: 11px; }
    </style>
</head>
<body>

<div class="header">
    <h1>صندوق البلالية الطبي</h1>
    <div style="color:var(--blue); font-weight:bold;">برمجة وتنفيذ: محمد هارون</div>
</div>

<div class="container">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
        <div class="stat-card">الصافي (ليرة) <span id="t-syp" style="color:var(--green)">0</span></div>
        <div class="stat-card">الصافي (دولار) <span id="t-usd" style="color:var(--gold)">0</span></div>
    </div>

    <div class="admin-box">
        <div id="lock-ui" style="text-align:center">
            <input type="password" id="p-word" placeholder="كلمة السر">
            <button class="btn btn-blue" onclick="goAdmin()">دخول الإدارة</button>
        </div>
        <div id="admin-ui" class="hidden">
            <input type="text" id="m-name" placeholder="اسم الشهر (فبراير 2026)">
            <button class="btn btn-blue" onclick="addM()">إضافة الشهر</button>
            <hr style="border:0; border-top:1px solid #334155; margin:15px 0;">
            <select id="m-list"></select>
            <input type="text" id="i-name" placeholder="الاسم / البيان">
            <input type="number" id="i-amt" placeholder="المبلغ">
            <select id="i-cur"><option value="SYP">ليرة سورية</option><option value="USD">دولار</option></select>
            <button class="btn btn-blue" onclick="saveI('member')">إضافة مشترك</button>
            <button class="btn btn-red" onclick="saveI('expense')">إضافة مصروف</button>
        </div>
    </div>
    <div id="data-view">جارٍ الاتصال بالسحابة...</div>
</div>

<script>
    const URL = "https://xuiwkvrhatcoovfozsq.supabase.co";
    const KEY = "sb_publishable_T2ltCUtwwPR4b_Oh_dOPFQ_qfcCmFfM";
    const _db = supabase.createClient(URL, KEY);

    let isAdm = false;

    function goAdmin() {
        if(document.getElementById('p-word').value === 'هارون456') {
            isAdm = true;
            document.getElementById('lock-ui').classList.add('hidden');
            document.getElementById('admin-ui').classList.remove('hidden');
            load();
        }
    }

    async function addM() {
        const val = document.getElementById('m-name').value;
        if(val) {
            await _db.from('months').insert([{ name: val }]);
            document.getElementById('m-name').value = '';
            load();
        }
    }

    async function saveI(type) {
        const mid = document.getElementById('m-list').value;
        const name = document.getElementById('i-name').value;
        const amt = parseFloat(document.getElementById('i-amt').value);
        const cur = document.getElementById('i-cur').value;
        if(!mid || !name || !amt) return alert('أكمل البيانات');
        await _db.from('data').insert([{ month_id: mid, name, amt, cur, type }]);
        document.getElementById('i-name').value = '';
        document.getElementById('i-amt').value = '';
        load();
    }

    async function del(id, tab) {
        if(confirm('حذف؟')) {
            await _db.from(tab).delete().eq('id', id);
            load();
        }
    }

    async function load() {
        const { data: months } = await _db.from('months').select('*').order('created_at', { ascending: false });
        const { data: info } = await _db.from('data').select('*');
        
        const area = document.getElementById('data-view');
        const sel = document.getElementById('m-list');
        area.innerHTML = ''; sel.innerHTML = '';

        let syp = 0, usd = 0;

        months.forEach(m => {
            sel.innerHTML += `<option value="${m.id}">${m.name}</option>`;
            let rows = '';
            info.filter(d => d.month_id === m.id).forEach(i => {
                const isE = i.type === 'expense';
                rows += `<tr style="${isE?'color:var(--red)':''}">
                    <td>${isE?'[صرف] ':''}${i.name}</td><td>${i.amt}</td><td>${i.cur}</td>
                    <td class="${isAdm?'':'hidden'}"><button onclick="del(${i.id},'data')">❌</button></td>
                </tr>`;
                let v = isE ? -i.amt : i.amt;
                if(i.cur === 'SYP') syp += v; else usd += v;
            });

            area.innerHTML += `<div class="month-block">
                <div class="m-header"><strong>${m.name}</strong>
                <button class="${isAdm?'':'hidden'}" onclick="del(${m.id},'months')">حذف الشهر</button></div>
                <table><thead><tr><th>البيان</th><th>المبلغ</th><th>العملة</th><th class="${isAdm?'':'hidden'}"></th></tr></thead>
                <tbody>${rows || '<tr><td colspan="4">لا بيانات</td></tr>'}</tbody></table></div>`;
        });
        document.getElementById('t-syp').innerText = syp.toLocaleString();
        document.getElementById('t-usd').innerText = usd.toLocaleString();
    }
    load();
</script>
</body>
</html>
